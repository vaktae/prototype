<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard | EcoLearn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&display=swap');
        body {
            font-family: 'Orbitron', monospace;
            background: 
                linear-gradient(45deg, #0d4f3c 0%, #1a6b4f 25%, #2d8f5f 50%, #1a6b4f 75%, #0d4f3c 100%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="pixel" x="0" y="0" width="10" height="10" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="%230d4f3c"/><rect width="5" height="5" fill="%231a6b4f"/><rect x="5" y="5" width="5" height="5" fill="%231a6b4f"/></pattern></defs><rect width="100" height="100" fill="url(%23pixel)"/></svg>');
            background-size: 100% 100%, 20px 20px;
            color: #f5f5f5;
            image-rendering: pixelated;
        }
        .leaderboard-card {
            background: linear-gradient(145deg, rgba(13, 79, 60, 0.8), rgba(26, 107, 79, 0.6));
            border: 2px solid #2d8f5f;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .rank-1 { background: linear-gradient(145deg, #f59e0b, #d97706); color: #111; }
        .rank-2 { background: linear-gradient(145deg, #9ca3af, #6b7280); color: #111; }
        .rank-3 { background: linear-gradient(145deg, #9a3412, #7c2d12); color: #eee; }
        .user-row:hover { background-color: #1f1f1f; }
        .current-user { border-left: 4px solid #2d8f5f; }
    </style>
</head>
<body class="min-h-screen">
    
    <!-- Navigation -->
    <nav class="bg-black bg-opacity-80 backdrop-blur-md fixed w-full z-50 border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <a href="index.html" class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-amber-600 via-green-500 to-sky-400 tracking-wide">EcoLearn</a>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="index.html" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Home</a>
                            <a href="games.html" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium"><i data-feather="gamepad-2" class="w-4 h-4 mr-1 inline"></i> Games</a>
                            <a href="profile.html" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium"><i data-feather="user" class="w-4 h-4 mr-1 inline"></i> Profile</a>
                            <a href="leaderboard.html" class="text-white px-3 py-2 rounded-md text-sm font-medium">Leaderboard</a>
                        </div>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-4 flex items-center md:ml-6">
                        <div class="ml-3 relative">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium">XP: <span id="xp-home">0</span></span>
                                <span class="text-sm font-medium text-yellow-400">Level: <span id="level-home">1</span></span>
                                <a href="profile.html"><img class="h-8 w-8 rounded-full" src="http://static.photos/people/200x200/1" alt="Profile"></a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" class="bg-gray-900 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-800 focus:outline-none" aria-controls="mobile-menu" aria-expanded="false">
                        <i data-feather="menu"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile menu -->
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="index.html" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Home</a>
                <a href="games.html" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Games</a>
                <a href="profile.html" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Profile</a>
                <a href="leaderboard.html" class="text-white block px-3 py-2 rounded-md text-base font-medium">Leaderboard</a>
            </div>
            <div class="pt-4 pb-3 border-t border-gray-700">
                <div class="flex items-center px-5">
                    <div class="flex-shrink-0">
                        <img class="h-10 w-10 rounded-full" src="http://static.photos/people/200x200/1" alt="Profile">
                    </div>
                    <div class="ml-3">
                        <div class="text-base font-medium text-white">Guest</div>
                        <div class="text-sm font-medium text-gray-400">Level 1</div>
                    </div>
                </div>
            <div class="mt-3 px-2 space-y-1">
                    <a href="#" class="block px-3 py-2 rounded-md text-base font-medium text-gray-400 hover:text-white hover:bg-gray-700">XP: <span id="mobile-xp">0</span></a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Leaderboard Section -->
    <div class="pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-4xl mx-auto">
        <div class="leaderboard-card rounded-xl p-6 mb-8" data-aos="fade-up">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                <h1 class="text-2xl font-bold">Leaderboards</h1>
                <div class="flex items-center gap-2">
                    <button id="tab-local" class="px-3 py-2 rounded-md text-sm font-medium bg-blue-600 text-white">Local</button>
                    <button id="tab-india" class="px-3 py-2 rounded-md text-sm font-medium bg-gray-800 text-gray-200 hover:bg-gray-700">India</button>
                    <button id="tab-global" class="px-3 py-2 rounded-md text-sm font-medium bg-gray-800 text-gray-200 hover:bg-gray-700">Global</button>
                    <button id="btn-my-rank" class="ml-2 px-3 py-2 rounded-md text-sm font-medium bg-gray-700 text-white hover:bg-gray-600">My Rank</button>
                </div>
            </div>
            
            <!-- Your Ranks Summary -->
            <div id="your-ranks" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                    <div class="text-xs text-gray-400">Your Local Rank</div>
                    <div id="rank-local" class="text-xl font-bold">#-</div>
                </div>
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                    <div class="text-xs text-gray-400">Your India Rank</div>
                    <div id="rank-india" class="text-xl font-bold">#-</div>
                </div>
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                    <div class="text-xs text-gray-400">Your Global Rank</div>
                    <div id="rank-global" class="text-xl font-bold">#-</div>
                </div>
            </div>

            <!-- Top 3 Users (dynamic) -->
            <div id="top3" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"></div>
            
            <!-- Sticky My Rank card -->
            <div id="my-rank-sticky" class="sticky top-20 z-40 mb-4 hidden">
                <div class="bg-gray-900 border border-blue-600 rounded-lg p-4 flex items-center">
                    <div class="text-xl font-bold text-blue-300 mr-4" id="my-rank-number">#-</div>
                    <img id="my-rank-avatar" class="h-10 w-10 rounded-full mr-4" src="http://static.photos/people/200x200/1" alt="You">
                    <div class="flex-1">
                        <div class="text-white font-medium" id="my-rank-name">Guest User (You)</div>
                        <div class="text-xs text-gray-400" id="my-rank-title">Hygiene Explorer</div>
                    </div>
                    <div class="text-sm">
                        <span class="text-blue-400 font-semibold" id="my-rank-level">1</span>
                        <span class="text-gray-400">•</span>
                        <span id="my-rank-xp">0 XP</span>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Table (dynamic) -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Rank</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">User</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Level</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">XP</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Quizzes</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-gray-800"></tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex items-center justify-between mt-6">
                <button id="btn-prev" class="px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-gray-700 disabled:opacity-50" disabled>Previous</button>
                <div id="pagination-text" class="text-sm text-gray-400"></div>
                <button id="btn-next" class="px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-gray-700" disabled>Next</button>
            </div>
        </div>
    </div>
    <!-- Floating rank badge -->
    <div id="floating-rank" class="fixed bottom-4 right-4 bg-gray-900/80 backdrop-blur-md border border-gray-700 text-white text-sm px-3 py-1 rounded-full shadow z-[60] hidden"></div>
    
    <script>
        // Init icon and animations after DOM update
        document.addEventListener('DOMContentLoaded', function() {
            if (window.AOS) { AOS.init(); }
            // Load stored avatar and name into header
            try {
                const storedAvatar = localStorage.getItem('profileAvatar');
                const storedName = localStorage.getItem('profileName');
                const storedXp = localStorage.getItem('xp');
                const storedLevel = localStorage.getItem('level');
                if (storedAvatar) {
                    document.querySelectorAll('nav img[alt="Profile"]').forEach(img => img.src = storedAvatar);
                }
                if (storedName) {
                    const mobileNameEl = document.querySelector('#mobile-menu .text-base.font-medium.text-white');
                    if (mobileNameEl) mobileNameEl.textContent = storedName;
                }
                // Populate XP/Level
                const xpEl = document.getElementById('xp-home');
                const lvlEl = document.getElementById('level-home');
                const mobileXp = document.getElementById('mobile-xp');
                const mobileLvl = document.getElementById('mobile-level');
                const xp = storedXp !== null ? parseInt(storedXp, 10) : 0;
                const level = storedLevel !== null ? parseInt(storedLevel, 10) : 1;
                if (xpEl) xpEl.textContent = isNaN(xp) ? 0 : xp;
                if (lvlEl) lvlEl.textContent = isNaN(level) ? 1 : level;
                if (mobileXp) mobileXp.textContent = isNaN(xp) ? 0 : xp;
                if (mobileLvl) mobileLvl.textContent = isNaN(level) ? 1 : level;
            } catch (e) { /* ignore */ }
            
        });

        // ---- References & Helpers ----
        const top3El = document.getElementById('top3');
        const tbodyEl = document.getElementById('table-body');
        const paginationText = document.getElementById('pagination-text');

        function sortByLevelXp(users) {
            return users.slice().sort((a, b) => {
                if (b.level !== a.level) return b.level - a.level;
                if (b.xp !== a.xp) return b.xp - a.xp;
                return (b.quizzes || 0) - (a.quizzes || 0);
            });
        }

        function computeRanks(users) {
            const sorted = sortByLevelXp(users);
            return sorted.map((u, i) => ({ ...u, rank: i + 1 }));
        }

        function findYourRank(users) {
            const ranked = computeRanks(users);
            const me = ranked.find(u => u.id === 'you');
            return me ? me.rank : '-';
        }

        function renderTop3(ranked) {
            const top = ranked.slice(0, 3);
            top3El.innerHTML = '';
            const cardHtml = (pos, u) => `
                <div class="${pos===0?'rank-2':pos===1?'rank-1':'rank-3'} p-4 rounded-lg flex flex-col items-center" data-aos="fade-up${pos===0? '" data-aos-delay="100': pos===2? '" data-aos-delay="200' : ''}">
                    <div class="text-4xl font-bold mb-2">${u.rank}</div>
                    <img src="${u.avatar}" class="${pos===1?'w-20 h-20':'w-16 h-16'} rounded-full border-4 border-white mb-3" alt="User">
                    <div class="font-bold text-center">${u.name}</div>
                    <div class="text-sm text-gray-800 font-medium">Lvl ${u.level} • ${u.xp} XP</div>
                    ${u.rank === 1 ? '<div class="mt-2"><i data-feather="award" class="w-5 h-5 text-yellow-700"></i></div>' : ''}
                </div>
            `;
            const arranged = [top[1], top[0], top[2]]; // [2nd,1st,3rd]
            arranged.forEach((u, i) => { if (u) top3El.insertAdjacentHTML('beforeend', cardHtml(i, u)); });
            if (window.feather) { feather.replace(); }
        }

        // ---- Fake Data Generation ----
        // Get stored profile info
        const storedName = localStorage.getItem('profileName') || 'Guest User';
        const storedAvatar = localStorage.getItem('profileAvatar') || 'http://static.photos/people/200x200/1';
        const storedXp = localStorage.getItem('xp');
        const storedLevel = localStorage.getItem('level');
        const storedQuizzes = localStorage.getItem('quizzes');

        const currentUser = {
            id: 'you',
            name: storedName,
            title: 'Hygiene Explorer',
            avatar: storedAvatar,
            level: storedLevel !== null ? parseInt(storedLevel, 10) : 1,
            xp: storedXp !== null ? parseInt(storedXp, 10) : 0,
            quizzes: storedQuizzes !== null ? parseInt(storedQuizzes, 10) : 5,
            city: 'Bengaluru',
            country: 'India'
        };

        function randomUser(id, name, avatarIdx, minLevel = 1, maxLevel = 6) {
            const level = Math.floor(Math.random() * (maxLevel - minLevel + 1)) + minLevel;
            const xp = level * 100 + Math.floor(Math.random() * 100);
            const quizzes = Math.floor(Math.random() * 12) + 1;
            const titles = ['Cleanliness Champion', 'Health Enthusiast', 'Sanitation Specialist', 'Hygiene Novice', 'Eco Warrior'];
            return {
                id,
                name,
                title: titles[Math.floor(Math.random() * titles.length)],
                avatar: `http://static.photos/people/200x200/${avatarIdx}`,
                level,
                xp,
                quizzes,
                city: ['Bengaluru','Mumbai','Delhi','Chennai','Kolkata','Pune'][Math.floor(Math.random()*6)],
                country: ['India','USA','UK','Canada','Australia','Germany'][Math.floor(Math.random()*6)]
            };
        }

        const baseNames = [
            'Alex Chen','Sarah Johnson','Michael Brown','Emily Wilson','David Kim','Jessica Lee','Robert Taylor','Priya Singh','Arjun Mehta','Ava Patel','Liam Smith','Olivia Davis','Noah Garcia','Emma Martinez','Amelia Thomas','Ishan Gupta','Kabir Verma','Zara Khan','Ivy Zhao','Lucas White','Maya Rao','Ananya Roy','Rohan Das','Ira Shah','Sofia Lewis'
        ];

        function buildCategory(includeCurrentUser) {
            const users = [];
            const targetFake = includeCurrentUser ? 9 : 10; // keep total at most 10 including you
            for (let i = 0; i < targetFake; i++) {
                const name = baseNames[i % baseNames.length];
                users.push(randomUser(`u${i}`, name, (i % 24) + 2));
            }
            if (includeCurrentUser) {
                users.push({...currentUser});
            }
            return users;
        }

        // Local: smaller pool, always include you
        const localData = buildCategory(true).map((u, idx) => ({...u, scope: 'Local'}));
        // India: medium pool, include you
        const indiaData = buildCategory(true).map((u, idx) => ({...u, scope: 'India'}));
        // Global: include you, cap to 10 total
        const globalData = buildCategory(true).map(u => ({...u, scope: 'Global'}));
        function rowHtml(u) {
            const isYou = u.id === 'you';
            return `
                <tr ${isYou ? 'id="row-you"' : ''} class="user-row ${isYou ? 'current-user bg-gray-900' : ''}">
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">${u.rank}</td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <img class="h-10 w-10 rounded-full" src="${u.avatar}" alt="User">
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-white">${u.name}${isYou ? ' (You)' : ''}</div>
                                <div class="text-sm text-gray-400">${u.title}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-blue-400">${u.level}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm">${u.xp}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm">${u.quizzes}</td>
                </tr>
            `;
        }

        // Pagination state
        let currentScope = 'Local';
        let currentPage = 1;
        const pageSize = 6;

        function setPaginationControls(totalItems) {
            const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
            if (currentPage > totalPages) currentPage = totalPages;
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(totalItems, currentPage * pageSize);
            document.getElementById('btn-prev').disabled = currentPage <= 1;
            document.getElementById('btn-next').disabled = currentPage >= totalPages;
            paginationText.innerHTML = `Showing <span class="font-medium">${start}</span> to <span class="font-medium">${end}</span> of <span class="font-medium">${totalItems}</span> users`;
        }

        function renderTable(ranked) {
            const startIdx = (currentPage - 1) * pageSize;
            const pageRows = ranked.slice(startIdx, startIdx + pageSize);
            tbodyEl.innerHTML = pageRows.map(rowHtml).join('');
            setPaginationControls(ranked.length);
        }

        function setActiveTab(scope) {
            const tabs = [
                ['tab-local','Local'],
                ['tab-india','India'],
                ['tab-global','Global']
            ];
            tabs.forEach(([id, name]) => {
                const el = document.getElementById(id);
                if (!el) return;
                if (name === scope) {
                    el.className = 'px-3 py-2 rounded-md text-sm font-medium bg-blue-600 text-white';
                } else {
                    el.className = 'px-3 py-2 rounded-md text-sm font-medium bg-gray-800 text-gray-200 hover:bg-gray-700';
                }
            });
        }

        function updateYourRanks() {
            document.getElementById('rank-local').textContent = '#' + findYourRank(localData);
            document.getElementById('rank-india').textContent = '#' + findYourRank(indiaData);
            document.getElementById('rank-global').textContent = '#' + findYourRank(globalData);
        }

        function render(scope) {
            setActiveTab(scope);
            currentScope = scope;
            currentPage = 1; // reset pagination on scope change
            let dataset = [];
            if (scope === 'Local') dataset = localData; else if (scope === 'India') dataset = indiaData; else dataset = globalData;
            const ranked = computeRanks(dataset);
            renderTop3(ranked);
            renderTable(ranked);
            if (window.AOS) { AOS.refreshHard && AOS.refreshHard(); }
            // Update floating rank badge and sticky card
            try {
                const fr = document.getElementById('floating-rank');
                const rank = findYourRank(dataset);
                fr.textContent = `${scope} Rank: #${rank}`;
                fr.classList.remove('hidden');

                const myCard = document.getElementById('my-rank-sticky');
                myCard.classList.remove('hidden');
                const me = ranked.find(u => u.id === 'you') || currentUser;
                document.getElementById('my-rank-number').textContent = `#${rank}`;
                document.getElementById('my-rank-name').textContent = `${me.name} (You)`;
                document.getElementById('my-rank-title').textContent = me.title;
                document.getElementById('my-rank-level').textContent = me.level;
                document.getElementById('my-rank-xp').textContent = `${me.xp} XP`;
                document.getElementById('my-rank-avatar').src = me.avatar;
            } catch (e) { /* ignore */ }
        }

        // Tab events
        document.getElementById('tab-local').addEventListener('click', () => render('Local'));
        document.getElementById('tab-india').addEventListener('click', () => render('India'));
        document.getElementById('tab-global').addEventListener('click', () => render('Global'));

        // Pagination events
        document.getElementById('btn-prev').addEventListener('click', function() {
            if (currentPage <= 1) return;
            currentPage--;
            const dataset = currentScope === 'Local' ? localData : currentScope === 'India' ? indiaData : globalData;
            const ranked = computeRanks(dataset);
            renderTable(ranked);
        });
        document.getElementById('btn-next').addEventListener('click', function() {
            const dataset = currentScope === 'Local' ? localData : currentScope === 'India' ? indiaData : globalData;
            const totalPages = Math.max(1, Math.ceil(dataset.length / pageSize));
            if (currentPage >= totalPages) return;
            currentPage++;
            const ranked = computeRanks(dataset);
            renderTable(ranked);
        });

        // Jump to My Rank button
        document.getElementById('btn-my-rank').addEventListener('click', function() {
            const row = document.getElementById('row-you');
            if (row) {
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // brief highlight
                row.classList.add('ring-2','ring-blue-500');
                setTimeout(() => row.classList.remove('ring-2','ring-blue-500'), 1200);
            }
        });

        // Initial load
        updateYourRanks();
        render('Local');
    </script>
</body>
</html>